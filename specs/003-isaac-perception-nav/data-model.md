# Data Model: Module 3 – The AI-Robot Brain (NVIDIA Isaac)

**Feature**: `003-isaac-perception-nav`
**Date**: 2025-12-09
**Phase**: Phase 1 (Design & Contracts)

## Purpose

This document defines the key entities, data structures, and relationships for Module 3 educational content. While this module is documentation (not a running system), defining the conceptual data model helps structure explanations and ensures students understand the data flowing through Isaac Sim → Isaac ROS VSLAM → Nav2 navigation pipeline.

## Entity Definitions

### 1. Isaac Sim Scene

**Description**: Virtual 3D environment for simulation in NVIDIA Isaac Sim

**Attributes**:
- `scene_id`: Unique identifier (USD file path, e.g., `/Isaac/Environments/Grid/default_environment.usd`)
- `environment_geometry`: 3D meshes representing buildings, terrain, obstacles (USD format)
- `robot_models`: URDF or USD robot descriptions (e.g., humanoid with articulated joints)
- `sensor_attachments`: List of sensors (cameras, LiDAR, IMU) with mounting positions
- `lighting_config`: HDRI environment map or directional light parameters (intensity, color temperature, position)
- `physics_settings`: Gravity vector, time step, solver iterations

**Relationships**:
- Contains 0 or more **Synthetic Data Samples** (generated via Replicator)
- Publishes sensor data to ROS 2 topics via Isaac Sim ROS 2 bridge

**Validation Rules**:
- `scene_id` must be valid USD file path
- `robot_models` must have valid URDF or USD format with articulated joints
- `lighting_config` intensity must be > 0

**State Transitions**: Static (loaded once) → Active (simulation running) → Paused → Terminated

---

### 2. Synthetic Data Sample

**Description**: Generated training/testing data from Isaac Sim Replicator

**Attributes**:
- `sample_id`: Unique identifier (sequential frame number or timestamp)
- `rgb_image`: H x W x 3 uint8 array (color image, 0-255 per channel)
- `depth_map`: H x W float32 array (distance in meters, 0.0 = invalid)
- `semantic_segmentation`: H x W int32 array (class ID per pixel, e.g., 0=background, 1=robot, 2=obstacle)
- `instance_segmentation`: H x W int32 array (unique object ID per pixel)
- `camera_pose`: Position (x, y, z in meters), orientation (quaternion: w, x, y, z)
- `timestamp`: Simulation time in seconds (float64)

**Relationships**:
- Generated by **Isaac Sim Scene** during Replicator capture loop
- Used to train perception models (outside scope of Module 3, mentioned conceptually)

**Validation Rules**:
- `rgb_image`, `depth_map`, `semantic_segmentation`, `instance_segmentation` must have same (H, W) dimensions
- `camera_pose` quaternion must be normalized (w² + x² + y² + z² = 1.0)
- `depth_map` values must be ≥ 0.0 (or NaN for invalid pixels)

**File Formats**: RGB/depth/segmentation exported as PNG or NumPy `.npy`, camera pose in JSON or ROS 2 bag

---

### 3. VSLAM Map

**Description**: Spatial representation built by Visual SLAM (Isaac ROS)

**Attributes**:
- `map_id`: Unique identifier (generated by `visual_slam_node`)
- `landmark_points`: List of 3D feature positions [(x₁, y₁, z₁), (x₂, y₂, z₂), ...] in `map` frame
- `keyframes`: List of camera poses at specific times (position, quaternion, timestamp)
- `covisibility_graph`: Edges connecting keyframes that observe the same landmarks (for loop closure)
- `loop_closure_edges`: Connections between revisited locations (corrects drift)

**Relationships**:
- Built incrementally from **Odometry Estimates** (visual odometry tracking)
- Provides `map` → `odom` transform for **Cost Map** (Nav2 localization)

**Validation Rules**:
- `landmark_points` must have at least 10 points for meaningful map (typical VSLAM requirement)
- `keyframes` timestamps must be monotonically increasing
- All positions and orientations in `map` frame

**State Transitions**: Initializing (first keyframe) → Tracking (adding landmarks) → Loop Closing (correcting drift) → Optimized (bundle adjustment complete)

---

### 4. Odometry Estimate

**Description**: Robot pose estimate from VSLAM (Isaac ROS `visual_slam_node` output)

**Attributes**:
- `position`: (x, y, z) in meters relative to `map` or `odom` frame
- `orientation`: Quaternion (w, x, y, z) representing robot heading
- `covariance`: 6x6 matrix (position xyz uncertainty + orientation rpy uncertainty)
- `frame_id`: Reference frame (`map` for global SLAM, `odom` for local tracking)
- `timestamp`: ROS 2 Time (seconds + nanoseconds)
- `child_frame_id`: Robot base frame (typically `base_link`)

**Relationships**:
- Published by Isaac ROS VSLAM as `/visual_slam/tracking/odometry` topic (nav_msgs/Odometry)
- Consumed by Nav2 for localization (transform `map` → `odom` → `base_link`)
- Updates **VSLAM Map** with new keyframe if movement exceeds threshold

**Validation Rules**:
- `orientation` quaternion must be normalized
- `covariance` must be symmetric positive semi-definite (physically meaningful uncertainty)
- `frame_id` typically `map` or `odom`, `child_frame_id` typically `base_link`

**ROS 2 Message Type**: `nav_msgs/Odometry`

---

### 5. Cost Map

**Description**: 2D occupancy grid for navigation planning (Nav2)

**Attributes**:
- `width`: Grid width in meters (float)
- `height`: Grid height in meters (float)
- `resolution`: Meters per cell (e.g., 0.05 = 5 cm per cell)
- `cells`: 2D array of uint8 values (0 = free space, 100 = occupied, 255 = unknown)
- `layers`: List of cost map layers (static obstacles, dynamic obstacles, inflation)
- `frame_id`: Reference frame (`map` for global cost map, `odom` for local cost map)
- `origin`: (x, y) position of grid bottom-left corner in `frame_id`

**Relationships**:
- **Global Cost Map**: Uses static map from SLAM or pre-built map, updated infrequently (~1 Hz)
- **Local Cost Map**: Uses real-time sensor data (LiDAR `/scan`, depth camera), updated frequently (~5-10 Hz)
- Consumed by **Global Path** planner and **Local Trajectory** planner

**Validation Rules**:
- `resolution` must be > 0.0 (typically 0.01 to 0.1 meters)
- `cells` dimensions must match `(width / resolution) x (height / resolution)`
- Cell values must be in range [0, 255]

**ROS 2 Message Type**: `nav_msgs/OccupancyGrid`

**Layers**:
1. **Static Layer**: Pre-built map or SLAM-generated map (obstacles known a priori)
2. **Obstacle Layer**: Real-time sensor data (e.g., LiDAR detects dynamic obstacles)
3. **Inflation Layer**: Adds safety padding around obstacles (configurable `inflation_radius`)

---

### 6. Navigation Goal

**Description**: Desired robot destination for autonomous navigation (Nav2)

**Attributes**:
- `goal_id`: Unique identifier for action tracking (generated by Nav2 action server)
- `target_position`: (x, y) in `map` frame (meters)
- `target_orientation`: Yaw angle (radians) or quaternion for final robot heading
- `position_tolerance`: Acceptable distance error (meters, typically 0.1-0.5)
- `angle_tolerance`: Acceptable orientation error (radians, typically 0.1-0.2)
- `timestamp`: When goal was submitted (ROS 2 Time)

**Relationships**:
- Submitted to Nav2 via `/goal_pose` topic or `NavigateToPose` action
- Triggers **Global Path** planning from current robot pose to goal
- Executes until robot reaches goal within tolerances or action is preempted/cancelled

**Validation Rules**:
- `target_position` must be within known map bounds (not in unknown or occupied space)
- `position_tolerance` and `angle_tolerance` must be > 0.0
- `target_orientation` quaternion must be normalized (if using quaternion)

**ROS 2 Message Type**: `geometry_msgs/PoseStamped` (for `/goal_pose` topic) or `nav2_msgs/action/NavigateToPose` (action interface)

---

### 7. Global Path

**Description**: Planned route from robot's current position to navigation goal (Nav2 global planner output)

**Attributes**:
- `path_id`: Unique identifier (generated by global planner)
- `waypoints`: Sequence of (x, y) positions in `map` frame [(x₁, y₁), (x₂, y₂), ..., (xₙ, yₙ)]
- `path_length`: Total Euclidean distance (meters)
- `planning_algorithm`: Algorithm used (NavFn, Dijkstra, A*, Smac Planner)
- `frame_id`: Reference frame (`map`)
- `timestamp`: When path was computed (ROS 2 Time)

**Relationships**:
- Computed by Nav2 global planner from **Cost Map** (global) and **Navigation Goal**
- Consumed by Nav2 local planner to generate **Local Trajectory**
- Recomputed if cost map changes significantly (e.g., new obstacle detected)

**Validation Rules**:
- First waypoint must be robot's current position (or very close)
- Last waypoint must match **Navigation Goal** `target_position` (within tolerance)
- All waypoints must be in free space on **Cost Map** (cell value < 100)

**ROS 2 Message Type**: `nav_msgs/Path` (published to `/plan` topic)

**Planning Algorithms** (Nav2 options):
- **NavFn**: Grid-based Dijkstra's algorithm (guaranteed optimal path)
- **Smac Planner**: State lattice planner for non-holonomic constraints (e.g., car-like motion)
- **ThetaStar**: Any-angle planner (smoother paths than grid-based)

---

### 8. Local Trajectory

**Description**: Short-term motion plan for dynamic obstacle avoidance (Nav2 local planner output)

**Attributes**:
- `trajectory_id`: Unique identifier (generated by local planner)
- `velocity_samples`: List of candidate velocities [(v₁, ω₁), (v₂, ω₂), ...] (linear v, angular ω)
- `trajectory_points`: Sequence of (x, y, θ) poses at discrete time steps (prediction horizon ~2-5 seconds)
- `cost_score`: Total cost (obstacle proximity + goal distance + path deviation + smoothness)
- `planning_algorithm`: Algorithm used (DWB, TEB, MPPI)
- `prediction_horizon`: Time duration for trajectory (seconds, typically 2.0-5.0)
- `timestamp`: When trajectory was computed (ROS 2 Time)

**Relationships**:
- Computed by Nav2 local planner from **Global Path**, **Cost Map** (local), and current robot state
- Converted to `/cmd_vel` (Twist message) by Nav2 controller (linear and angular velocities)
- Recomputed at high frequency (~10-20 Hz) for real-time obstacle avoidance

**Validation Rules**:
- All `trajectory_points` must be collision-free on **Cost Map** (local)
- `velocity_samples` must be within robot's kinematic limits (max linear velocity, max angular velocity)
- `prediction_horizon` must be > 0.0

**ROS 2 Message Type**: `nav_msgs/Path` (published to `/local_plan` topic), `geometry_msgs/Twist` (published to `/cmd_vel`)

**Planning Algorithms** (Nav2 options):
- **DWB (Dynamic Window Approach)**: Samples velocity space, scores trajectories by cost function (fast, widely used)
- **TEB (Timed Elastic Band)**: Trajectory optimization with time constraints (smoother motion)
- **MPPI (Model Predictive Path Integral)**: Sampling-based optimal control (handles complex dynamics)

---

## Data Flow Diagram

```mermaid
graph LR
    A[Isaac Sim Scene] -->|ROS 2 Bridge| B[/camera/image_raw]
    B --> C[Isaac ROS VSLAM]
    C --> D[Odometry Estimate]
    D --> E[Nav2 Localization]
    E --> F[Cost Map]
    G[Navigation Goal] --> H[Global Planner]
    F --> H
    H --> I[Global Path]
    I --> J[Local Planner]
    F --> J
    J --> K[Local Trajectory]
    K --> L[/cmd_vel]

    style A fill:#e1f5ff
    style C fill:#d4b3ff
    style H fill:#ffd699
    style J fill:#ffd699
```

**Legend**:
- Blue: Isaac Sim (simulation and data generation)
- Purple: Perception (VSLAM)
- Orange: Planning (Nav2 global and local planners)
- Green: ROS 2 topics (data flow)

---

## Entity Relationships Summary

| Entity | Generates | Consumes | Published ROS 2 Topic |
|--------|-----------|----------|----------------------|
| **Isaac Sim Scene** | Synthetic Data Sample | - | `/camera/image_raw`, `/camera/camera_info` |
| **Synthetic Data Sample** | - | (Training data for perception models, outside scope) | N/A (exported to files) |
| **VSLAM Map** | - | Odometry Estimate (incremental updates) | N/A (internal to `visual_slam_node`) |
| **Odometry Estimate** | - | Isaac Sim camera images | `/visual_slam/tracking/odometry` |
| **Cost Map** | - | VSLAM localization (`map` → `odom` transform), sensor data (`/scan`) | `/global_costmap/costmap`, `/local_costmap/costmap` |
| **Navigation Goal** | - | - | `/goal_pose` (input to Nav2) |
| **Global Path** | - | Cost Map (global), Navigation Goal | `/plan` |
| **Local Trajectory** | - | Global Path, Cost Map (local), robot state | `/local_plan`, `/cmd_vel` |

---

## Data Validation and Testing

**For Educational Content** (Module 3):
- Students will NOT implement these entities in code (conceptual understanding only)
- Validation criteria: Students can identify entity attributes, explain relationships, and trace data flow through pipeline (per success criteria SC-001 through SC-010)

**For Code Examples**:
- Python Replicator script must generate **Synthetic Data Samples** with correct attributes (RGB, depth, segmentation)
- YAML configs must define valid parameters for **Odometry Estimate** (Isaac ROS VSLAM) and **Cost Map** (Nav2)
- Bash commands must demonstrate querying ROS 2 topics (e.g., `ros2 topic echo /visual_slam/tracking/odometry` shows **Odometry Estimate** structure)

---

## References

- [NVIDIA Isaac Sim USD Formats](https://docs.nvidia.com/isaac/doc/isaac_sim/usd.html)
- [ROS 2 nav_msgs/Odometry](https://docs.ros2.org/foxy/api/nav_msgs/msg/Odometry.html)
- [ROS 2 nav_msgs/OccupancyGrid](https://docs.ros2.org/foxy/api/nav_msgs/msg/OccupancyGrid.html)
- [Nav2 Cost Map Documentation](https://navigation.ros.org/configuration/packages/costmap-plugins/index.html)
- [Isaac ROS Visual SLAM](https://nvidia-isaac-ros.github.io/repositories_and_packages/isaac_ros_visual_slam/index.html)
